import logging
from typing import List
from .base import ImageProvider

# Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ñ‹
from .playground import PlaygroundProvider  # ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð»Ð¸ ÐºÐ»Ð°ÑÑ? Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚, Ð¾ÑÑ‚Ð°Ð²ÑŒ HuggingFaceProvider
from .flux_klein import FluxKleinProvider
from .qwen import QwenProvider
from .z_image import ZImageProvider
from .radames import RadamesProvider
from .pixazo import PixazoProvider
from .leonardo import LeonardoProvider

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð³ÐµÑ€ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°
logger = logging.getLogger(__name__)

# ÐŸÑ€Ð¸Ð³Ð»ÑƒÑˆÐ°ÐµÐ¼ httpx Ð»Ð¾Ð³Ð¸ (heartbeat 404 Ð¸ Ð¿Ñ€Ð¾Ñ‡Ð¸Ð¹ ÑˆÑƒÐ¼ Ð¾Ñ‚ Gradio Client)
logging.getLogger("httpx").setLevel(logging.WARNING)


def generate_image_sync(
        prompt: str,
        negative_prompt: str,
        width: int,
        height: int
) -> bytes:

    # === Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯ ===
    # 1. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ°Ð¼Ñ‹Ðµ ÐºÑ€ÑƒÑ‚Ñ‹Ðµ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ðµ (Playground, Flux, Qwen)
    # 2. ÐŸÐ¾Ñ‚Ð¾Ð¼ Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ/CPU (Radames Lightning)
    # 3. LeonardoAI (ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹)
    # 4. Ð’ ÑÐ°Ð¼Ð¾Ð¼ ÐºÐ¾Ð½Ñ†Ðµ - Ð¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹/ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ (Pixazo)

    providers: List[ImageProvider] = [
        #PlaygroundProvider(),  # 1. Ð¢Ð¾Ð¿ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ (45 ÑÐµÐº)
        #FluxKleinProvider(),  # 2. Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð¸ ÐºÑ€ÑƒÑ‚Ð¾Ð¹ (30 ÑÐµÐº)
        LeonardoProvider(),    # 3. Leonardo AI (GPT-1.5 / Nano / SeeDream)
        #QwenProvider(),  # 4. Ð£Ð¼Ð½Ñ‹Ð¹, Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÐµÑ‚ ÑÑ†ÐµÐ½Ñ‹ (60 ÑÐµÐº)
        #ZImageProvider(),  # 5. Ð¢ÑÐ¶ÐµÐ»Ñ‹Ð¹, Ð½Ð¾ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ (45 ÑÐµÐº)
        #RadamesProvider(),  # 6. Ð¡Ð¿Ð¸Ð´ÑÑ‚ÐµÑ€ SDXL Lightning (15 ÑÐµÐº)
        #PixazoProvider()  # 7. ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ Ð Ð£Ð‘Ð•Ð– (Ð’ÑÐµÐ³Ð´Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚)
    ]

    errors = []

    # Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»Ð¾ Ð²ÑÐµÐ¹ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
    logger.info(f"ðŸŽ¬ [Orchestrator] New Request: '{prompt[:40]}...' Size: {width}x{height}")

    for i, provider in enumerate(providers, 1):
        logger.info(f"ðŸ”„ [Orchestrator] Step {i}/{len(providers)}: Launching >>> {provider.name} <<<")

        try:
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ
            result = provider.generate(prompt, negative_prompt, width, height)

            # Ð•ÑÐ»Ð¸ Ð´Ð¾ÑˆÐ»Ð¸ ÑÑŽÐ´Ð° - Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ ÑƒÑÐ¿ÐµÑ…
            logger.info(f"âœ… [Orchestrator] SUCCESS! Image generated by {provider.name}")
            return result

        except Exception as e:
            err_msg = str(e)

            # ÐšÑ€Ð°ÑÐ¸Ð²Ð¾ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ
            if "quota" in err_msg.lower() or "429" in err_msg:
                logger.warning(f"[Orchestrator] {provider.name} hit QUOTA/LIMIT. Moving next...")
            elif "timeout" in err_msg.lower():
                logger.warning(f"[Orchestrator] {provider.name} TIMED OUT (Queue too long). Moving next...")
            else:
                logger.error(f"[Orchestrator] {provider.name} FAILED: {err_msg}")

            # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð´Ð»Ñ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
            errors.append(f"{provider.name}: {err_msg}")
            continue

    # Ð•ÑÐ»Ð¸ Ñ†Ð¸ÐºÐ» Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»ÑÑ, Ð° Ð¼Ñ‹ Ð·Ð´ÐµÑÑŒ â€” Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ ÑƒÐ¿Ð°Ð» Ð´Ð°Ð¶Ðµ Pixazo
    final_error = f"ALL PROVIDERS DEAD. Details: {'; '.join(errors)}"
    logger.critical(final_error)
    raise Exception(final_error)